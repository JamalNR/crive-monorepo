name: hardening/12 SBOM

on:
  pull_request:
    branches: [hardening/12-licenses, main]
  push:
    branches: [hardening/12-licenses]

permissions:
  contents: read

jobs:
  sbom:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Enable Corepack & pnpm
        run: |
          set -euo pipefail
          corepack enable
          corepack prepare pnpm@10.14.2 --activate
          pnpm -v
      - name: Install (frozen, no scripts)
        run: pnpm install --frozen-lockfile --ignore-scripts
      - name: Generate CycloneDX SBOM (JSON)
        run: |
          set -euo pipefail
          pnpm dlx -y @cyclonedx/cyclonedx-npm \
            --spec-version 1.5 \
            --output-file sbom.json \
            --output-format json || true
          test -s sbom.json || echo '{"bomFormat":"CycloneDX","components":[]}' > sbom.json
          jq '.components|length as $n | "components: \($n)"' sbom.json
      - uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.json
