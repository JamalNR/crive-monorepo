name: env-quarterly-review
on:
  schedule:
    # 1 Jan/Apr/Jul/Okt 03:00 UTC
    - cron: '0 3 1 1,4,7,10 *'
  workflow_dispatch:

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with: { node-version: "24" }

      # Inject token Doppler STG & PRD via environment (cukup 1 token dengan akses read)
      - name: Configure Doppler
        uses: dopplerhq/gh-action@v2
        with:
          doppler-token: ${{ secrets.DOPPLER_TOKEN_STG }}
          project: crive
          config: stg
        env:
          DOPPLER_ENABLE_CLI: "true"

      # Jalankan script untuk STG & PRD (gunakan CLI doppler langsung)
      - name: Install Doppler CLI
        run: curl -Ls https://dl.doppler.com/install.sh | sh

      - name: Quarterly ENV Review
        id: review
        env:
          PROJECT: crive
          CONFS: "stg prd"
        run: |
          PATH="$PATH:/usr/local/bin"
          OUTDIR=$(bash scripts/env_quarterly_review.sh)
          echo "outdir=$OUTDIR" >> $GITHUB_OUTPUT

      - name: Create PR
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "docs(env): quarterly review ${{ steps.review.outputs.outdir }}"
          title: "ENV Quarterly Review â€“ ${{ steps.review.outputs.outdir }}"
          body: "Auto-generated review artefacts in ${{ steps.review.outputs.outdir }}.\n\nPlease review RBAC in Doppler dashboard & approve."
          branch: chore/env-review/${{ steps.review.outputs.outdir }}
          delete-branch: true
