#!/usr/bin/env sh
set -e

# Daftar file yang benar-benar STAGED (Add/Copy/Modify/Rename)
STAGED_FILES="$(git diff --cached --name-only --diff-filter=ACMR)"

# Blokir jika ada .env* (kecuali .env.example) yang TER-STAGE
STAGED_ENV_FILES="$(printf '%s\n' "$STAGED_FILES" \
  | grep -E '^(.*/)?\.env(\..*)?$' \
  | grep -v '\.env\.example$' || true)"

if [ -n "$STAGED_ENV_FILES" ]; then
  echo "❌ Blocked: jangan commit file .env* berikut:"
  printf '%s\n' "$STAGED_ENV_FILES"
  exit 1
fi

# Secret scan pada KONTEN file staged (exclude .husky/** & scripts/**)
SECRET_RE='(sk_live_|sk_test_|AKIA[0-9A-Z]{16}|AIzaSy|xoxb-|-----BEGIN (EC|RSA|OPENSSH) PRIVATE KEY-----)'
for f in $STAGED_FILES; do
  case "$f" in
    .husky/*|scripts/*) continue ;;
  esac
  if git show ":$f" | grep -I -E -i "$SECRET_RE" >/dev/null; then
    echo "❌ Blocked: terdeteksi pola rahasia di file: $f"
    exit 1
  fi
done

# Validasi ENV lokal
pnpm -w run check:env:local
