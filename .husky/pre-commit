#!/usr/bin/env sh
set -e

# Block commit file .env* (kecuali .env.example)
STAGED_ENV="$(git diff --cached --name-only -- . ':(exclude).husky/**' \
  | awk '/(^|\/)\.env($|\.)(.*)/ && !/\.env\.example$/')"
[ -n "$STAGED_ENV" ] && echo "❌ Blocked: jangan commit .env*" && echo "$STAGED_ENV" && exit 1

# Secret scan (exclude .husky/** & scripts/** agar tak kena pola contoh di checker)
if git diff --cached -U0 -- . ':(exclude).husky/**' ':(exclude)scripts/**' \
 | grep -E -i '^\+[^+].*(sk_live_|sk_test_|AKIA[0-9A-Z]{16}|AIzaSy|xoxb-|-----BEGIN (EC|RSA|OPENSSH) PRIVATE KEY-----)' >/dev/null; then
  echo "❌ Blocked: terdeteksi pola rahasia di staged changes."
  exit 1
fi

# Validasi ENV lokal (no-op di CI)
pnpm -w run check:env:local
