#!/usr/bin/env bash
. "$(dirname "$0")/_/husky.sh"

echo "🔒 Running pre-commit checks..."

# 1) Blokir file .env*
if git diff --cached --name-only | grep -E '\.env($|\.|/)' >/dev/null; then
  echo "❌ Commit diblokir: file .env* tidak boleh di-commit."
  exit 1
fi

DIFF="$(git diff --cached)"

# 2) Deteksi rahasia high-signal saja (minim false positive)
if printf "%s" "$DIFF" | grep -E -i \
'(-----BEGIN [A-Z ]*PRIVATE KEY-----|\
ghp_[A-Za-z0-9]{36}|\
(AKIA|ASIA)[0-9A-Z]{16}|\
AIza[0-9A-Za-z_-]{35}|\
xox[baprs]-[A-Za-z0-9-]{10,48}|\
sk_(live|test)_[A-Za-z0-9]{10,}|\
Bearer[[:space:]]+[A-Za-z0-9._-]{20,})' >/dev/null; then
  echo "❌ Commit diblokir: terdeteksi STRING RAHASIA berisiko tinggi."
  exit 1
fi

echo "✅ Pre-commit checks passed."
